name: Build and Push Docker Images

on:
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        include: # Full semver versions
          - terraform_version: 1.3.10
          - terraform_version: 1.4.7
          - terraform_version: 1.5.7
            is_latest: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract major.minor version and determine latest
        id: version_processing
        run: |
          # Extract major.minor version (e.g., 1.2.3 -> 1.2)
          VERSION="${{ matrix.terraform_version }}"
          MAJOR_MINOR=$(echo "$VERSION" | awk -F. '{print $1"."$2}')
          echo "MAJOR_MINOR_VERSION=$MAJOR_MINOR" >> $GITHUB_ENV

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          build-args: TERRAFORM_VERSION=${{ matrix.terraform_version }}
          tags: |
            massdrivercloud/provisioner-terraform:${{ env.MAJOR_MINOR_VERSION }}
            ${{ matrix.is_latest && 'massdrivercloud/provisioner-terraform:latest' || '' }}